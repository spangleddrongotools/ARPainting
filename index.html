<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>AR Painting</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <style>
    html,body{margin:0;height:100%;overflow:hidden;background:transparent;}
    canvas{background:transparent!important;}
    #hud{position:fixed;top:10px;left:10px;z-index:9999;
      color:#fff;background:#0009;padding:6px 10px;border-radius:8px;
      font:14px/1.3 -apple-system,BlinkMacSystemFont,Segoe UI,system-ui;}
    #closeBtn{
      display:none;position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
      z-index:9999;padding:10px 20px;border:none;border-radius:8px;
      background:#000c;color:#fff;font-size:16px;}
    a-scene{opacity:0;transition:opacity .6s ease;}
    a-scene.visible{opacity:1;}
  </style>
</head>
<body>
  <div id="hud">scanning…</div>
  <button id="closeBtn">Exit</button>

  <a-scene
    mindar-image="imageTargetSrc: targets.mind; uiLoading:false; uiError:false; uiScanning:false; maxTrack:1"
    color-space="sRGB" embedded
    renderer="alpha:true;colorManagement:true;physicallyCorrectLights:true"
    vr-mode-ui="enabled:false" device-orientation-permission-ui="enabled:false">

    <a-assets>
      <video id="overlay" src="overlay.mp4" preload="auto" playsinline webkit-playsinline loop></video>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>

    <a-entity id="target" mindar-image-target="targetIndex:0">
      <a-entity id="vidPlane"
        geometry="primitive:plane;width:1;height:1.57"
        material="shader:flat;src:#overlay;transparent:false"
        position="0 0 0" rotation="0 0 0">
      </a-entity>
    </a-entity>

  </a-scene>

  <script>
    document.addEventListener('DOMContentLoaded',()=>{
      const scene=document.querySelector('a-scene');
      const target=document.getElementById('target');
      const video=document.getElementById('overlay');
      const hud=document.getElementById('hud');
      const closeBtn=document.getElementById('closeBtn');
      const setHUD=m=>hud.textContent=m;

      target.addEventListener('targetFound',async()=>{
        setHUD('target found — playing');
        scene.classList.add('visible');
        try{
          video.muted=false;
          video.currentTime=0;
          await video.play();
        }catch(e){
          setHUD('tap to start');
          const tapOnce=()=>{video.play().then(()=>setHUD('playing…'));document.body.removeEventListener('click',tapOnce);};
          document.body.addEventListener('click',tapOnce);
        }
        closeBtn.style.display='block';
      });

      target.addEventListener('targetLost',()=>setHUD('scanning…'));

      closeBtn.addEventListener('click',()=>{
        setHUD('closing…');
        try{video.pause();}catch(e){}
        try{
          const sys=scene.systems['mindar-image-system'];
          if(sys&&typeof sys.stop==='function')sys.stop();
          const cam=sys?.video;
          const stream=cam?.srcObject||cam?.el?.srcObject;
          if(stream&&stream.getTracks)stream.getTracks().forEach(t=>t.stop());
        }catch(e){}
        window.close(); // may be blocked on mobile; fallback:
        setTimeout(()=>window.location.href='about:blank',800);
      });
    });
  </script>
</body>
</html>
