<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>AR Painting — Animation Launch</title>

  <!-- A-Frame and MindAR -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    html, body {margin:0;height:100%;overflow:hidden;background:transparent;}
    canvas {background:transparent !important;}
    #hud {
      position:fixed;top:10px;left:10px;z-index:9999;
      color:#fff;background:#0009;padding:6px 10px;border-radius:8px;
      font:14px/1.2 -apple-system,BlinkMacSystemFont,Segoe UI,system-ui;
    }
    #closeBtn {
      display:none;position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
      z-index:9999;padding:10px 20px;border:none;border-radius:8px;
      background:#000c;color:#fff;font-size:16px;
    }
    a-scene {opacity:0;transition:opacity 600ms ease;}
    a-scene.visible {opacity:1;}
  </style>
</head>
<body>
  <div id="hud">scanning…</div>
  <button id="closeBtn">Close safely</button>

  <a-scene
    mindar-image="imageTargetSrc: targets.mind; uiLoading:false; uiError:false; uiScanning:false; maxTrack:1"
    color-space="sRGB"
    embedded
    renderer="alpha:true; colorManagement:true; physicallyCorrectLights:true"
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:false">

    <a-assets>
      <!-- IMPORTANT: no autoplay/loop/muted here; we control in JS -->
      <video id="overlay" src="overlay.mp4" preload="auto" playsinline webkit-playsinline></video>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>

    <a-entity id="target" mindar-image-target="targetIndex:0">
      <a-entity id="vidPlane"
        geometry="primitive: plane; width: 1; height: 1.57"
        material="shader: flat; src: #overlay; transparent:false"
        position="0 0 0" rotation="0 0 0">
      </a-entity>
    </a-entity>

  </a-scene>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const scene   = document.querySelector('a-scene');
      const target  = document.getElementById('target');     // <-- listen here
      const video   = document.getElementById('overlay');
      const hud     = document.getElementById('hud');
      const closeBtn= document.getElementById('closeBtn');
      const setHUD  = msg => hud.textContent = msg;

      // iOS safety: make sure inline playback is allowed
      video.setAttribute('playsinline','true');
      video.setAttribute('webkit-playsinline','true');

      let playedOnce = false;

      // Start when the marker is found
      target.addEventListener('targetFound', async () => {
        setHUD('target FOUND — starting animation');
        scene.classList.add('visible');

        try {
          video.loop = false;       // stop after first run
          video.muted = false;      // enable audio
          video.currentTime = 0;    // rewind
          await video.play();       // try to play (may throw on iOS if no gesture)
        } catch (e) {
          // Fallback: ask for a single tap to start
          setHUD('tap anywhere to start animation (audio)');
          const tapOnce = () => {
            video.play().then(()=> setHUD('playing…')).catch(()=> setHUD('tap again to start…'));
            document.body.removeEventListener('click', tapOnce, {once:true});
          };
          document.body.addEventListener('click', tapOnce, {once:true});
        }

        if (!playedOnce) {
          playedOnce = true;
          video.addEventListener('ended', () => {
            setHUD('animation complete');
            closeBtn.style.display = 'block';
          }, { once: true });
        }
      });

      target.addEventListener('targetLost', () => setHUD('target LOST — scanning…'));

      // Close safely: pause video and stop camera
      closeBtn.addEventListener('click', () => {
        setHUD('closing safely…');
        try { video.pause(); } catch(e){}
        try {
          const sys = scene.systems['mindar-image-system'];
          if (sys && typeof sys.stop === 'function') sys.stop();
          const camVideo = sys?.video;
          const stream = camVideo?.srcObject || camVideo?.el?.srcObject || null;
          if (stream && stream.getTracks) stream.getTracks().forEach(t=>t.stop());
        } catch(e){}
        scene.style.display = 'none';
        setTimeout(()=>{ setHUD('closed'); }, 200);
      });

      setHUD('scanning…');
    });
  </script>
</body>
</html>
